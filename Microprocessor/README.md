# ATmega128 Rhythm Game Master (SPI Protocol)

μ΄ ν”„λ΅μ νΈλ” ATmega128 λ§μ΄ν¬λ΅μ»¨νΈλ΅¤λ¬λ¥Ό λ§μ¤ν„°(Master)λ΅ μ‚¬μ©ν•μ—¬ κµ¬ν„ν• λ¦¬λ“¬ κ²μ„ μ»¨νΈλ΅¤λ¬ μ†μ¤ μ½”λ“μ…λ‹λ‹¤. SPI ν†µμ‹ μ„ ν†µν•΄ μ¬λ μ΄λΈ(Slave) μ¥μΉμ™€ λ°μ΄ν„°λ¥Ό λ™κΈ°ν™”ν•λ©°, λ²„νΌ μ…λ ¥μ„ ν†µν•΄ κ²μ„μ„ μ§„ν–‰ν•κ³  μ μλ¥Ό κ³„μ‚°ν•©λ‹λ‹¤.

## π“‹ ν”„λ΅μ νΈ κ°μ”

- **νμΌλ…**: `UART Protocol Test for Master.c` (ν”„λ΅μ νΈ λ…μΉ­μ€ UARTμ΄λ‚ μ‹¤μ  κµ¬ν„μ€ SPI ν†µμ‹  μ‚¬μ©)
- **μ‘μ„±μΌ**: 2019-12-12
- **MCU**: ATmega128 (Master Node)

## β™οΈ ν•λ“μ›¨μ–΄ κµ¬μ„± λ° ν•€ λ§µ

### SPI ν†µμ‹  (Master β†” Slave)

| Master Pin | κΈ°λ¥ | μ„¤λ…                | μ—°κ²°      |
| ---------- | ---- | ------------------- | --------- |
| **PB0**    | /SS  | Slave Select        | Slave PB0 |
| **PB1**    | SCK  | Serial Clock        | Slave PB1 |
| **PB2**    | MOSI | Master Out Slave In | Slave PB2 |
| **PB3**    | MISO | Master In Slave Out | Slave PB3 |

### μ…λ ¥ μΈν„°νμ΄μ¤ (λ²„νΌ)

| Pin     | μΈν„°λ½νΈ | κΈ°λ¥                   | μ„¤λ…              |
| ------- | -------- | ---------------------- | ----------------- |
| **PD0** | INT0     | Game Button 1 (Orange) | λ¦¬λ“¬ κ²μ„ μ…λ ¥    |
| **PD1** | INT1     | Game Button 2 (Green)  | λ¦¬λ“¬ κ²μ„ μ…λ ¥    |
| **PD2** | INT2     | Game Button 3 (Red)    | λ¦¬λ“¬ κ²μ„ μ…λ ¥    |
| **PD3** | INT3     | Game Button 4 (Brown)  | λ¦¬λ“¬ κ²μ„ μ…λ ¥    |
| **PE4** | INT4     | Menu Select (SW1)      | κ³΅ λ²νΈ λ³€κ²½      |
| **PE5** | INT5     | Game Start/End (SW2)   | κ²μ„ μ‹μ‘ λ° μΆ…λ£ |

## π® κΈ°λ¥ μ„¤λ…

### 1. λ™μ‘ λ¨λ“ (Master Mode)

μ‹μ¤ν…μ€ λ‘ κ°€μ§€ λ¨λ“λ΅ λ™μ‘ν•λ©° `PE5` λ²„νΌμΌλ΅ μ „ν™λ©λ‹λ‹¤.

- **Menu Mode (Mode 1)**

  - μ΄κΈ° μƒνƒμ…λ‹λ‹¤.
  - FNDμ— ν„μ¬ μ„ νƒλ κ³΅ λ²νΈ(`count`)λ¥Ό ν‘μ‹ν•©λ‹λ‹¤.
  - `PE4` λ²„νΌμ„ λλ¬ κ³΅ λ²νΈλ¥Ό 1~8κΉμ§€ λ³€κ²½ν•  μ μμµλ‹λ‹¤.

- **Game Mode (Mode 2)**
  - `PE5` λ²„νΌμ„ λλ¬ κ²μ„μ„ μ‹μ‘ν•λ©΄ SPIλ¥Ό ν†µν•΄ μ¬λ μ΄λΈμ— κ³΅ λ²νΈλ¥Ό μ „μ†΅ν•©λ‹λ‹¤.
  - κ²μ„ μ¤‘μ—λ” νλ“ν• μ μ(`score`)κ°€ FNDμ— ν‘μ‹λ©λ‹λ‹¤.
  - κ²μ„ μΆ…λ£ μ‹ `PE5`λ¥Ό λ‹¤μ‹ λ„λ¥΄λ©΄ μΆ…λ£ μ‹ νΈ(404 -> 148)λ¥Ό μ „μ†΅ν•κ³  λ©”λ‰΄λ΅ λ³µκ·€ν•©λ‹λ‹¤.

### 2. λ¦¬λ“¬ κ²μ„ λ΅μ§

- **κ³΅ λ°μ΄ν„°**: 'λ–³λ‹¤ λ–³λ‹¤ λΉ„ν–‰κΈ°'μ λ°•μ λ°μ΄ν„°κ°€ `make_airplane_correct_time_array()` ν•¨μμ— μ •μλμ–΄ μμµλ‹λ‹¤.
- **μ μ νμ • (`getScore`)**:
  - μ‚¬μ©μκ°€ λ²„νΌμ„ λ„λ¥Έ μ‹μ (`msec`)κ³Ό μ •λ‹µ λ°°μ—΄(`correct_msec_time`)μ„ λΉ„κµν•©λ‹λ‹¤.
  - μ¤μ°¨ λ²”μ„(`tolerance_ms`, 250ms) λ‚΄μ— μ •ν™•ν• λ²„νΌμ„ μ…λ ¥ν•λ©΄ 5μ μ„ νλ“ν•©λ‹λ‹¤.
  - μ—°μ† μ…λ ¥ λ°©μ§€ λ° λ””λ°”μ΄μ‹± λ΅μ§μ΄ ν¬ν•¨λμ–΄ μμµλ‹λ‹¤.

## π’Ύ μ£Όμ” ν•¨μ

- `SPI_Masterinit()`, `SPI_TX()`: SPI ν†µμ‹  μ΄κΈ°ν™” λ° λ°μ΄ν„° μ „μ†΅.
- `make_airplane_correct_time_array()`: κ²μ„ λ…ΈνΈ(νƒ€μ΄λ°) λ°°μ—΄ μƒμ„±.
- `getScore(button, time)`: μ…λ ¥λ λ²„νΌκ³Ό νƒ€μ΄λ°μ„ μ±„μ .
- `ISR(INTx_vect)`: κ° λ²„νΌ(κ²μ„ λ° μ μ–΄)μ— λ€ν• μΈν„°λ½νΈ μ²λ¦¬.

## β οΈ μ°Έκ³  μ‚¬ν•­

- λ©”μΈ λ£¨ν”„(`while(1)`)μ—μ„ `msec` λ³€μλ¥Ό μ¦κ°€μ‹ν‚¤λ” λ°©μ‹μΌλ΅ μ‹κ°„μ„ μΈ΅μ •ν•©λ‹λ‹¤. λ”°λΌμ„ FND ν‘μ‹ ν•¨μ(`FND_show_number`)μ μ‹¤ν–‰ μ‹κ°„μ— λ”°λΌ νƒ€μ΄λ° μ†λ„κ°€ κ²°μ •λ©λ‹λ‹¤.
- `SPI_TX` ν•¨μλ” `unsigned char` (1λ°”μ΄νΈ) λ°μ΄ν„°λ¥Ό μ „μ†΅ν•λ―€λ΅, κ²μ„ μΆ…λ£ μ‹ νΈμΈ `404`λ” μ¤λ²„ν”λ΅μ°λμ–΄ `148`(`0x94`)λ΅ μ „μ†΅λ©λ‹λ‹¤.

---
